<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geocoding Test - Vehicle Intelligence</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #ffffff; 
        }
        .test-container { 
            max-width: 800px; 
            margin: 0 auto; 
        }
        .test-input { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border: 1px solid #333; 
            background: #2a2a2a; 
            color: #fff;
            border-radius: 4px;
        }
        .test-button { 
            padding: 12px 24px; 
            background: #ff5722; 
            color: white; 
            border: none; 
            cursor: pointer;
            border-radius: 4px;
            margin: 5px;
        }
        .test-button:hover { 
            background: #e64a19; 
        }
        .results { 
            margin-top: 20px; 
            padding: 15px; 
            background: #2a2a2a; 
            border-radius: 4px;
        }
        .success { 
            color: #4caf50; 
        }
        .error { 
            color: #f44336; 
        }
        .warning { 
            color: #ff9800; 
        }
        .log { 
            font-family: monospace; 
            font-size: 12px; 
            background: #1e1e1e; 
            padding: 10px; 
            margin: 5px 0;
            border-radius: 4px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üó∫Ô∏è Enhanced Geocoding Test</h1>
        <p>Test the enhanced geocoding function for UK addresses</p>
        
        <div>
            <input type="text" id="addressInput" class="test-input" 
                   placeholder="Enter UK address to test (e.g., Flying Fields, Daventry Road, Southam, CV471AS)"
                   value="Flying Fields, Daventry Road, Southam, CV471AS">
        </div>
        
        <div>
            <button class="test-button" onclick="testAddress()">üîç Test Address</button>
            <button class="test-button" onclick="testProblematicAddresses()">üß™ Test All Problematic</button>
            <button class="test-button" onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>
        
        <div id="results" class="results" style="display: none;">
            <h3>Test Results</h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        // Enhanced geocoding function (same as in VehicleSearchPage.jsx)
        async function getCoordinates(address) {
            if (!address) return null;
            
            // Check cache first
            const cacheKey = `geocode_${address.toLowerCase().trim()}`;
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                try {
                    const parsedCache = JSON.parse(cached);
                    // Cache for 7 days
                    if (Date.now() - parsedCache.timestamp < 7 * 24 * 60 * 60 * 1000) {
                        console.log(`[Geocoding] Using cached result for "${address}"`);
                        return parsedCache.coords;
                    } else {
                        localStorage.removeItem(cacheKey);
                    }
                } catch (e) {
                    localStorage.removeItem(cacheKey);
                }
            }
            
            try {
                // Multiple search strategies for UK addresses
                const searchStrategies = [
                    address, // Original address
                    address.replace(/([A-Z]{1,2}\\d{1,2}[A-Z]?)(\\d[A-Z]{2})/i, '$1 $2'), // Fix postcode spacing
                    address.replace(/^[\\d\\s]*([A-Z\\s]+)$/i, '$1').trim(), // Remove house numbers for street-only searches
                    address.split(',').slice(-2).join(',').trim(), // Last two parts (usually area + postcode)
                    address.split(',').slice(-1)[0].trim(), // Just the postcode/area
                    // Extract just the main street and area
                    address.replace(/^[^,]*,?\\s*([A-Z\\s]+(?:ROAD|STREET|LANE|AVENUE|CLOSE|DRIVE|WAY|PLACE|CRESCENT|GARDENS))[,\\s]+([A-Z\\s]+).*$/i, '$1, $2'),
                    // Extract just the town/city
                    address.match(/([A-Z\\s]+)(?:,\\s*[A-Z]{1,2}\\d{1,2}[A-Z]?\\s*\\d[A-Z]{2})?$/i)?.[1]?.trim()
                ].filter((addr, index, arr) => addr && addr.length > 2 && arr.indexOf(addr) === index); // Remove duplicates and short strings
                
                let bestResult = null;
                let bestScore = 0;
                
                for (const searchAddr of searchStrategies) {
                    try {
                        console.log(`[Geocoding] Trying strategy: "${searchAddr}"`);
                        
                        const response = await fetch(
                            `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(searchAddr)}&format=json&limit=3&countrycodes=gb&addressdetails=1`,
                            {
                                headers: {
                                    'User-Agent': 'VehicleIntelligenceSystem/1.0'
                                }
                            }
                        );
                        
                        if (!response.ok) {
                            console.warn(`[Geocoding] HTTP error ${response.status} for "${searchAddr}"`);
                            continue;
                        }
                        
                        const data = await response.json();
                        console.log(`[Geocoding] Found ${data.length} results for "${searchAddr}"`);
                        
                        if (data && data.length > 0) {
                            // Score results based on relevance to original address
                            for (const result of data) {
                                let score = 0;
                                const displayName = result.display_name.toLowerCase();
                                const originalLower = address.toLowerCase();
                                
                                // Scoring system
                                if (result.importance) score += result.importance * 10;
                                if (displayName.includes(originalLower.split(',')[0]?.trim())) score += 5;
                                if (result.address?.postcode && originalLower.includes(result.address.postcode.toLowerCase())) score += 8;
                                if (result.address?.city && originalLower.includes(result.address.city.toLowerCase())) score += 6;
                                if (result.address?.town && originalLower.includes(result.address.town.toLowerCase())) score += 6;
                                if (result.address?.road && originalLower.includes(result.address.road.toLowerCase())) score += 7;
                                
                                console.log(`[Geocoding] Result score: ${score.toFixed(2)} for "${result.display_name}"`);
                                
                                if (score > bestScore) {
                                    bestScore = score;
                                    bestResult = {
                                        lat: parseFloat(result.lat),
                                        lng: parseFloat(result.lon),
                                        displayName: result.display_name,
                                        searchStrategy: searchAddr,
                                        confidence: Math.min(score / 10, 1)
                                    };
                                }
                            }
                            
                            // If we found a good result, break early
                            if (bestScore > 8) {
                                console.log(`[Geocoding] High confidence result found, stopping search`);
                                break;
                            }
                        }
                        
                        // Rate limiting: wait 100ms between requests
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (strategyError) {
                        console.warn(`[Geocoding] Strategy failed for "${searchAddr}":`, strategyError);
                    }
                }
                
                if (bestResult) {
                    console.log(`[Geocoding] SUCCESS: Found coordinates for "${address}" using strategy "${bestResult.searchStrategy}"`);
                    console.log(`[Geocoding] Result: ${bestResult.lat}, ${bestResult.lng} (confidence: ${(bestResult.confidence * 100).toFixed(1)}%)`);
                    
                    // Cache the result
                    localStorage.setItem(cacheKey, JSON.stringify({
                        coords: bestResult,
                        timestamp: Date.now()
                    }));
                    
                    return bestResult;
                } else {
                    console.warn(`[Geocoding] FAILED: No coordinates found for "${address}"`);
                    return null;
                }
                
            } catch (error) {
                console.error(`[Geocoding] ERROR for "${address}":`, error);
                return null;
            }
        }

        async function testAddress() {
            const address = document.getElementById('addressInput').value.trim();
            if (!address) {
                alert('Please enter an address to test');
                return;
            }

            showResults();
            const resultDiv = document.getElementById('resultContent');
            resultDiv.innerHTML = `<div class="warning">üîÑ Testing address: "${address}"</div>`;
            
            // Clear console for clean log output
            console.clear();
            
            const startTime = Date.now();
            const result = await getCoordinates(address);
            const endTime = Date.now();
            
            let html = `<div class="log">Address: "${address}"\\nTime: ${endTime - startTime}ms\\n\\n`;
            
            if (result) {
                html += `<div class="success">‚úÖ SUCCESS!</div>`;
                html += `<div class="log">`;
                html += `Coordinates: ${result.lat}, ${result.lng}\\n`;
                html += `Location: ${result.displayName}\\n`;
                html += `Search Strategy: "${result.searchStrategy}"\\n`;
                html += `Confidence: ${(result.confidence * 100).toFixed(1)}%\\n`;
                html += `Google Maps: https://maps.google.com/?q=${result.lat},${result.lng}\\n`;
                html += `OpenStreetMap: https://www.openstreetmap.org/#map=15/${result.lat}/${result.lng}`;
                html += `</div>`;
            } else {
                html += `<div class="error">‚ùå FAILED</div>`;
                html += `<div class="log">No coordinates found for this address</div>`;
            }
            
            resultDiv.innerHTML = html;
        }

        async function testProblematicAddresses() {
            const addresses = [
                'Flying Fields, Daventry Road, Southam, CV471AS',
                '11 BERKSHIRES ROAD CAMBERLEY',
                'Daventry Road, Southam',
                'Camberley'
            ];

            showResults();
            const resultDiv = document.getElementById('resultContent');
            resultDiv.innerHTML = `<div class="warning">üß™ Testing ${addresses.length} problematic addresses...</div>`;
            
            console.clear();
            
            let html = '';
            for (const address of addresses) {
                const startTime = Date.now();
                const result = await getCoordinates(address);
                const endTime = Date.now();
                
                html += `<hr><div class="log">Address: "${address}"\\nTime: ${endTime - startTime}ms</div>`;
                
                if (result) {
                    html += `<div class="success">‚úÖ SUCCESS: ${result.lat}, ${result.lng}</div>`;
                    html += `<div class="log">Strategy: "${result.searchStrategy}" | Confidence: ${(result.confidence * 100).toFixed(1)}%</div>`;
                } else {
                    html += `<div class="error">‚ùå FAILED</div>`;
                }
            }
            
            resultDiv.innerHTML = html;
        }

        function showResults() {
            document.getElementById('results').style.display = 'block';
        }

        function clearResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('resultContent').innerHTML = '';
            console.clear();
        }
    </script>
</body>
</html>